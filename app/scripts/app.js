'use strict'/*global angular:false */var app = angular.module('DSW', ['ngRoute']);app.controller('appController', ['$scope', '$http',  function($scope, $http) {    //alert control    $scope.numberOfAlerts = 0;    $scope.alertsExpand = false;    $scope.alerts = [];    $scope.toggle = function() {      $scope.alertsExpand = !$scope.alertsExpand;      $scope.patientsExpand = false;      $scope.getAlerts();    };    $scope.getAlerts = function() {      $http.get("Nalert.php")        .success(function(data) {          var alertsTemp = [];          // console.log('before:' + data.records);          $scope.numberOfAlerts = data.records.length;          for (var i = 0; i < data.records.length; i++) {            var msg = '';            var id = '';            var date = '';            if (data.records[i][5] === '1') {              data.records[i][5] = 'Patient is out of boundaries';            } else if (data.records[i][5] === '2') {              data.records[i][5] = "patient's watch's battery low";            } else if (data.records[i][5] === '3') {              data.records[i][5] = "Patient pressed the panic button";            } else if (data.records[i][5] === '4') {              data.records[i][5] = "Patient turned the watch on";            } else if (data.records[i][5] === '5') {              data.records[i][5] = "Patient turned the watch off";            };            msg = data.records[i][5];            id = data.records[i][0];            date = data.records[i][4];            //add lat and lng            alertsTemp[i] = [id, msg, date]          };          $scope.alerts = alertsTemp;          // change error-read to true after clicking on errors          // console.log('after:' + $scope.alerts);        });    };		//********************************************************************************	//clear alert  $scope.clearAllAlerts = function(){    console.log('boom');    var da = $.param('s');    $http({        method: 'POST',        url: 'clearallalerts.php',        data: da,        headers: {          'Content-Type': 'application/x-www-form-urlencoded'        }      }).success(function(data) {        console.log('huh?');        if (data == "S") {          $scope.getAlerts();          console.log('success!');        } else {          console.log('blah FAIL');          // alert("fail");        }      });  };	$scope.clearAlert = function(alert) {	var da = $.param({        alertid: alert[0]      });      console.log(da);          $http({        method: 'POST',        url: 'clearalert.php',        data: da,        headers: {          'Content-Type': 'application/x-www-form-urlencoded'        }      }).success(function(data) {        console.log(data);        if (data == "S") {          $scope.getAlerts();          console.log('success!');        } else {          console.log('blah FAIL');          // alert("fail");        }      });	};	//****************************************************************************************		    //login control    $scope.loggedIn = false;    $scope.user = '';    $scope.pass = '';    $scope.login = function() {      var d = $.param({        username: $scope.user,        password: $scope.pass      });      console.log(d);      $http({        method: 'POST',        url: 'logincheck.php',        data: d,        headers: {          'Content-Type': 'application/x-www-form-urlencoded'        }      }).success(function(data) {        console.log(data);        if (data == $scope.user) {          $scope.loggedIn = true;          showMarkers();        } else {          alert("Wrong details, try again.")        }      });      // $scope.tab=2;      // $scope.reloadMap = function(){      //   console.log('blah');      //   application.tab = 2;      //   checkResize();      // };      $scope.getAlerts();      $scope.showPatients();    }    //patient control    $scope.patientCount = 0;     $scope.alertsExpand = false;    $scope.patients = [];    $scope.selectedPatient = undefined;    $scope.patientsExpand = false;    $scope.addingPatient = false;    $scope.editingPatient = false;    $scope.pToggle = function() {      $scope.patientsExpand = !$scope.patientsExpand;      $scope.alertsExpand = false;      $scope.showPatients();    };    $scope.showPatients = function() {      $http.get('showpatient.php')        .success(function(data) {          var patientTemp = [];          // console.log('before:' + data.records);          $scope.patientCount = data.people.length;          for (var i = 0; i < data.people.length; i++) {            var a = '';            var b = '';            var c = '';            var d = '';            var e = '';            var f = '';            var g = '';            var h = '';            var j = '';            a = data.people[i]['device_id'];            b = data.people[i]['relative_username'];            c = data.people[i]['patient_name'];            d = data.people[i]['contact_person'];            e = data.people[i]['contact_number'];            f = data.people[i]['date_of_birth'];            g = data.people[i]['gender'];            h = data.people[i]['medicine'];            j = data.people[i]['medicine_time'];            patientTemp[i] = {              deviceid: a,              relativeusername: b,              patientname: c,              contactperson: d,              contactnumber: e,              dateofbirth: f,              gender: g,              medicine: h,              medicine_time: j            }          };          $scope.patients = patientTemp;          if (!$scope.selectedPatient) {            $scope.initialisePatient();          }          // console.log("patients:" + $scope.patients);          // console.log("first" + $scope.patients[0]);          // change error-read to true after clicking on errors          // console.log('after:' + $scope.alerts);        });    }    $scope.initialisePatient = function() {      $scope.selectedPatient = $scope.patients[0];      // console.log("selected" + $scope.selectedPatient);    }	//current patient's marker    function updateMarker(patient) {      var id = patient.deviceid;      var da = $.param({        patientid: id      });      console.log('da' + da);      $http({        method: 'POST',        url: 'update_location.php',        data: da,        headers: {          'Content-Type': 'application/x-www-form-urlencoded'        }      }).success(function(data) {        console.log(data.location);        marker.setPosition(new google.maps.LatLng(data.location[0].lat, data.location[0].lng));        map.panTo(new google.maps.LatLng(data.location[0].lat, data.location[0].lng));      });    }			//current patient's multi-fences	$scope.numberOfFence = 0;	$scope.expand = false;	$scope.fences = [];	function updatefences(patient) {	      var cityCircle;	      var mapd = $.param({        pid: patient.deviceid      });      // console('getting fence?');      $http({        method: 'POST',        url: 'getfence.php',        data: mapd,        headers: {          'Content-Type': 'application/x-www-form-urlencoded'        }      }).success(function(data) {          var fenceTemp = [];          // console.log('before:' + data.records);			  if (typeof cityCircle === 'undefined') {		  } else {		  		  //for (var n = 0; n < $scope.nn; n++) {		  //var delcir = $scope.circles[n];		  //new google.maps.Circle(delcir).setMap(map);		  //}		  cityCircle.setMap(null);		  }		  		  $scope.numberOfFence = data.fences.length;          for (var i = 0; i < data.fences.length; i++) {            var aa = '';            var bb = '';            var cc = '';			var dd = '';			var ee = '';                       aa = data.fences[i]['idgeofences'];            bb = data.fences[i]['centerlat'];            cc = data.fences[i]['centerlong'];			dd = data.fences[i]['radius'];			ee = data.fences[i]['patientid'];								    var cir = [];			cir[i] = {			strokeColor: "#c3fc49",			strokeOpacity: 0.8,			strokeWeight: 2,			fillColor: "#c3fc49",			fillOpacity: 0.35,			map: map,			center: new google.maps.LatLng(bb, cc),			radius: parseInt(dd)			};			cityCircle = new google.maps.Circle(cir[i])						            fenceTemp[i] = {idgeo: aa, cenlat: bb, cenlong: cc, radi: dd, patid: ee}						};			$scope.circles = cir;			//$scope.nn = cir.length;			$scope.fences = fenceTemp;		      });	 }			//update marker and fences    $scope.selectPatient = function(patient) {      $scope.selectedPatient = patient;      updateMarker($scope.selectedPatient);	    updatefences($scope.selectedPatient);    }    $scope.selectPatientAndToggle = function(patient) {      $scope.selectedPatient = patient;      updateMarker($scope.selectedPatient);	    updatefences($scope.selectedPatient);      $scope.pToggle();    }			 	 	 	     $scope.editPatient = function(patient) {      $scope.pn = patient.patientname;      $scope.di = patient.deviceid;      $scope.cp = patient.contactperson;      $scope.cn = patient.contactnumber;      $scope.dob = new Date(patient.dateofbirth);      $scope.gen = patient.gender;      $scope.mn = patient.medicine;      $scope.mt = new Date(patient.medicine_time);      $scope.addingPatient = true;      $scope.editingPatient= true;    }    $scope.delPatient = function(){      var da = $.param({        deviceid: $scope.di      });      $http({        method: 'POST',        url: 'delpatient.php',        data: da,        headers: {          'Content-Type': 'application/x-www-form-urlencoded'        }      }).success(function(data) {        console.log(data);        if (data == "S") {          $scope.addingPatient = false;        } else {          alert("fail");        }      });      $scope.showPatients();    }    $scope.addPatient = function() {      $scope.pn = undefined;      $scope.di = undefined;      $scope.cp = undefined;      $scope.cn = undefined;      $scope.dob = undefined;      $scope.gen = undefined;      $scope.mn = undefined;      $scope.mt = undefined;      $scope.addingPatient = true;      $scope.editingPatient = false;    }    $scope.addPost = function() {      var da = $.param({        patientnadd: $scope.pn,        deviceiadd: $scope.di,        contactpadd: $scope.cp,        contactnadd: $scope.cn,        dateoadd: $scope.dob,        genadd: $scope.gen,        mnadd: $scope.mn,        mtadd: $scope.mt        // mediadd: $scope.me      });      console.log($scope.dob);      $http({        method: 'POST',        url: 'addp.php',        data: da,        headers: {          'Content-Type': 'application/x-www-form-urlencoded'        }      }).success(function(data) {        console.log(data);        if (data == "S") {          $scope.addingPatient = false;        } else {          alert("fail");        }      });      $scope.showPatients();    }  }]);app.controller('settingsCtrl', ['$scope',  function($scope) {    initialize();  }]);app.controller('homeCtrl', ['$scope',  function($scope) {    initialize();    $scope.$watch('loggedIn', function() {      if ($scope.loggedIn) showMarkers();    });  }]);app.config(function($routeProvider, $locationProvider) {  $routeProvider.  when("/", {    templateUrl: 'views/tracking.html',    controller: 'homeCtrl'  }).  when("/settings", {    templateUrl: 'views/settings.html',    controller: 'settingsCtrl'  });  // $locationProvider.html5Mode(true);});// app.directive('tracking', function(){//   return {//     restrict: 'E',//     templateUrl: 'views/tracking.html'//   };// });// app.directive('settings', function(){//   return {//     restrict: 'E',//     templateUrl: 'views/settings.html'//   };// });app.directive('alerts', function() {  return {    restrict: 'A',    templateUrl: 'views/alerts.html'  };});app.directive('patients', function() {  return {    restrict: 'A',    templateUrl: 'views/patients.html'  };});app.directive('login', function() {  return {    restrict: 'E',    templateUrl: 'views/login.html'  };});